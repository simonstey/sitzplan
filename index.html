<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Seating Chart</title>
    <meta
      name="description"
      content="A seating chart editor for assigning places at tables."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Copyright 1998-2020 by Northwoods Software Corporation. -->
    <style type="text/css">
      /* CSS for the traditional context menu */
      .menu {
        display: none;
        position: absolute;
        opacity: 0;
        margin: 0;
        padding: 0;
        z-index: 999;
        box-shadow: 0 5px 5px -3px rgba(0, 0, 0, 0.2),
          0 8px 10px 1px rgba(0, 0, 0, 0.14), 0 3px 14px 2px rgba(0, 0, 0, 0.12);
        list-style: none;
        background-color: #ffffff;
        border-radius: 4px;
      }

      .menu-item {
        display: block;
        position: relative;
        min-width: 60px;
        margin: 0;
        padding: 6px 16px;
        font: bold 12px sans-serif;
        color: rgba(0, 0, 0, 0.87);
        cursor: pointer;
      }

      .menu-item::before {
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0;
        pointer-events: none;
        content: "";
        width: 100%;
        height: 100%;
        background-color: #000000;
      }

      .menu-item:hover::before {
        opacity: 0.04;
      }

      .menu .menu {
        top: -8px;
        left: 100%;
      }

      .show-menu,
      .menu-item:hover > .menu {
        display: block;
        opacity: 1;
      }
    </style>
    <style>
      /* Use a Flexbox to make the Palette/Diagram responsive */
      #myFlexDiv {
        display: -webkit-flex;
        display: flex;
        flex-flow: row wrap;
        width: 100%;
        justify-content: center;
      }

      @media (min-width: 768px) {
        #myGuests {
          width: 200px;
          height: 500px;
          margin-right: 10px;
        }

        #myDiagramDiv {
          height: 500px;
          flex: 1;
        }
      }

      @media (max-width: 767px) {
        #myGuests {
          width: 90%;
          height: 100px;
          margin-bottom: 10px;
        }

        #myDiagramDiv {
          width: 90%;
          height: 500px;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
      integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
      crossorigin="anonymous"
    ></script>

    <script src="release/go.js"></script>
    <!-- <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/codemirror.min.js"
      integrity="sha256-sRwcFCKzBvYiAJfddXlx1Ld5+hAxpYzCM+drX/GHMKE="
      crossorigin="anonymous"
    ></script> -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/codemirror.min.css"
    />

    <script src="js/vendor/qrcode.min.js"></script>
    <!-- <script src="assets/js/goSamples.js"></script> -->
    <!-- this is only for the GoJS Samples framework -->
    <script src="https://cdn.jsdelivr.net/npm/copy-to-clipboard@3.3.1/example/index.js"></script>
    <script src="assets/require.js"></script>

    <script>
      /* TinyURL JS API
  @author: Ephellon Dantzler
  @timestamp: Sunday August 13, 2017 02:04:32 CST (-06:00)
*/
      // JavaScript Emulation from "1.8.5" to "1.3"

      // C -> XRequest

      function ProperURL__String(url) {
        if (ProperURL.test(url)) return new URL(url);
        try {
          // Missing protocol
          if (/([\w]+)\.([\w]+)(\/.+)?$/i.test(url))
            return new URL("http://" + RegExp.$_);
        } catch (error) {
          throw new URIError("Failed to construct 'URL': Invalid URL");
        }
      }

      ProperURL.test = function test(url) {
        try {
          new URL(url);
        } catch (error) {
          return false;
        }
        return true;
      };

      function tinyurl__Object_Function(options, callback) {
        var head = "https://www.tinyurl.com/api-create.php?url=",
          url = head + encodeURIComponent(options.url),
          start,
          end,
          count,
          fetching,
          timeout = options.timeout;
        tinyurl.callback = callback;

        if (timeout != undefined && timeout != null) {
          start = new Date().getTime();
          XRequest(options, callback);
          for (
            count = 0, end = start + timeout * 1000, fetching = true;
            fetching && count < end;
            count = new Date().getTime()
          )
            fetching = XRequest.status == undefined || XRequest.status == null;
          end = count;

          XRequest.request = { start: start, end: end, span: end - start };
        } else {
          XRequest({ url: url, method: options.method || "GET" }, callback);
        }
      }

      function tinyurl__Object(options) {
        if (options.callback != undefined && options.callback != null)
          return tinyurl(options, options.callback);
        if (options.success != undefined && options.success != null)
          return tinyurl(options, options.success);
        return tinyurl(options, function () {});
      }

      function tinyurl__String_Object(url, options) {
        if (ProperURL.test(url)) return tinyurl(new URL(url), options);
        else return tinyurl(ProperURL(url), options);
      }

      function tinyurl__String_Function(url, callback) {
        if (ProperURL.test(url))
          return tinyurl(new URL(url), { method: "GET", callback: callback });
        else
          return tinyurl(ProperURL(url), { method: "GET", callback: callback });
      }

      function tinyurl__String(url) {
        return tinyurl(url, { method: "GET" });
      }

      function tinyurl__URL(url) {
        return tinyurl({ method: "GET", url: url.href });
      }

      function tinyurl__URL_Object(url, options) {
        return tinyurl(Object.assign({ url: url.href }, options));
      }

      tinyurl.toString = function toString(url, options) {
        if (url != undefined && url != null)
          return tinyurl.apply(null, arguments);
        return tinyurl.url;
      };

      // https://robwu.nl/cors-anywhere.html
      var updateURLInterval;

      function XRequest(options, callback) {
        var API_URL = "https://cors-anywhere.herokuapp.com/",
          XHR = new XMLHttpRequest();
        XHR.open(options.method, API_URL + options.url);
        XHR.onload = function () {
          var args = arguments;
          return setTimeout(function () {
            return callback.apply(null, args);
          }, 100);
        };
        XHR.onerror = options.error;

        if (/^POST/i.test(options.method))
          XHR.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
          );

        try {
          XRequest.request = XHR;
          updateURLInterval = setInterval(function () {
            tinyurl.preview = (tinyurl.url =
              XRequest.request.responseText || "").replace(
              /\:\/\/(w+\.)?/,
              "://$1preview."
            );
            if (tinyurl.url != "") clearInterval(updateURLInterval);
          }, 1);
          XHR.send();
        } catch (error) {
          XHR.onerror.apply(null, error);
        }
      }

      function ProperURL() {
        var index = 0,
          args = arguments,
          types = Types.apply(null, arguments).split(","),
          check = Types.check,
          oftype = Types.oftype;
        switch (types + "") {
          case "String" + "":
            return ProperURL__String.apply(null, args);
            break;
          default:
            throw TypeError("ProperURL(" + types + ") is undefined");
            break;
        }
      }

      function tinyurl() {
        var index = 0,
          args = arguments,
          types = Types.apply(null, arguments).split(","),
          check = Types.check,
          oftype = Types.oftype;
        switch (types + "") {
          case "URL,Object" + "":
            return tinyurl__URL_Object.apply(null, args);
            break;
          case "URL" + "":
            return tinyurl__URL.apply(null, args);
            break;
          case "String,Object" + "":
            return tinyurl__String_Object.apply(null, args);
            break;
          case "String,Function" + "":
            return tinyurl__String_Function.apply(null, args);
            break;
          case "String" + "":
            return tinyurl__String.apply(null, args);
            break;
          case "Object,Function" + "":
            return tinyurl__Object_Function.apply(null, args);
            break;
          case "Object" + "":
            return tinyurl__Object.apply(null, args);
            break;
          default:
            throw TypeError("tinyurl(" + types + ") is undefined");
            break;
        }
      }

      window.tinyurl = tinyurl;

      function Types() {
        for (
          var index = 0, results = [], args = [].slice.call(arguments), arg;
          index < args.length;
          index++
        )
          if (
            (arg = args[index]) != undefined &&
            arg != null &&
            arg.constructor == Function &&
            arg.name != undefined &&
            arg.name != null &&
            arg.name != ""
          )
            results.push(arg.name);
          else if (arg != undefined && arg != null)
            results.push(arg.constructor.name);
          else results.push(typeof arg);
        return results.join(",");
      }
      Types.check = function (a, b) {
        var c = RegExp("^(\\b" + a + "\\b,?)+$").test(b),
          d = c
            ? RegExp.$_
            : b.replace(RegExp("^(\\b" + a + "\\b,?)+"), "").split(","),
          i = (check.failIndex = c ? -1 : (b = b.split(",")).length - d.length);
        return (check.fail = c ? "" : b.slice(i, b.length) + ""), c;
      };
      Types.oftype = function (a, b) {
        return check(a, b + "") ? b : b.slice(0, (index = check.failIndex));
      };
    </script>
    <script id="code">
      var head = document.getElementsByTagName("head")[0];

      var link = document.createElement("link");
      link.type = "text/css";
      link.rel = "stylesheet";
      link.href = "assets/css/bootstrap.min.css";
      head.appendChild(link);

      link = document.createElement("link");
      link.type = "text/css";
      link.rel = "stylesheet";
      link.href = "assets/css/highlight.css";
      head.appendChild(link);

      link = document.createElement("link");
      link.type = "text/css";
      link.rel = "stylesheet";
      link.href = "assets/css/main.css";
      head.appendChild(link);
      function jsonToUri(v, r, s) {
        return encodeURIComponent(
          JSON.stringify(v, r, s)
            .replace(/[()'~_!*]/g, function (c) {
              // Replace ()'~_!* with \u0000 escape sequences
              return "\\u" + ("0000" + c.charCodeAt(0).toString(16)).slice(-4);
            })
            .replace(/\{/g, "(") //    { -> (
            .replace(/\}/g, ")") //    } -> )
            .replace(/"/g, "'") //    " -> '
            .replace(/\:/g, "~") //    : -> ~
            .replace(/,/g, "_") //    , -> _
            .replace(/\[/g, "!") //    [ -> !
            .replace(/\]/g, "*") //    ] -> *
        );
      }

      function uriToJson(t, r) {
        return JSON.parse(
          decodeURIComponent(t)
            .replace(/\(/g, "{") //    ( -> {
            .replace(/\)/g, "}") //    ) -> }
            .replace(/'/g, '"') //    ' -> "
            .replace(/~/g, ":") //    ~ -> :
            .replace(/_/g, ",") //    _ -> ,
            .replace(/\!/g, "[") //    ! -> [
            .replace(/\*/g, "]"), //    * -> ]
          r
        );
      }

      function init() {
        //  if (window.goSamples) goSamples(); // init for these samples -- you don't need to call this
        var $ = go.GraphObject.make;

        // Initialize the main Diagram
        myDiagram = $(go.Diagram, "myDiagramDiv", {
          allowDragOut: true, // to myGuests
          "contextMenuTool.defaultTouchContextMenu": null,
          allowClipboard: false,
          draggingTool: $(SpecialDraggingTool),
          rotatingTool: $(HorizontalTextRotatingTool),
          "clickCreatingTool.archetypeNodeData": {
            // allow double-click in background to create a new node
            category: "TableR3",
            name: "",
            color: "red",
            guests: {},
          },
          "clickCreatingTool.insertPart": function (loc, cat) {
            // scroll to the new node
            var node = go.ClickCreatingTool.prototype.insertPart.call(
              this,
              loc
            );
            node.category = cat ? cat : "TableR3";
            if (node !== null) {
              this.diagram.select(node);
              this.diagram.commandHandler.scrollToPart(node);
              // this.diagram.commandHandler.editTextBlock(
              //   node.findObject("NAMETB")
              // );
            }
            return node;
          },
          // For this sample, automatically show the state of the diagram's model on the page
          ModelChanged: function (e) {
            if (e.isTransactionFinished) {
              document.getElementById("mySavedModel").value =
                '{\n "plan": ' +
                myDiagram.model.toJson() +
                ",\n" +
                '"students":' +
                myGuests.model.toJson() +
                "}";
              prettyPrint();
            }
          },
          "undoManager.isEnabled": true,
        });

        // when the document is modified, add a "*" to the title and enable the "Save" button
        myDiagram.addDiagramListener("Modified", function (e) {
          var button = document.getElementById("SaveButton");
          if (button) button.disabled = !myDiagram.isModified;
          var idx = document.title.indexOf("*");
          if (myDiagram.isModified) {
            if (idx < 0) document.title += "*";
          } else {
            if (idx >= 0) document.title = document.title.substr(0, idx);
          }
        });
        // myDiagram.nodeTemplate.contextMenu = $(
        //   "ContextMenu",
        //   $("ContextMenuButton", $(go.TextBlock, "Bigger"), {
        //     click: function (e, obj) {
        //       changeTextSize(obj, 1.1);
        //     },
        //   }),
        //   $("ContextMenuButton", $(go.TextBlock, "Smaller"), {
        //     click: function (e, obj) {
        //       changeTextSize(obj, 1 / 1.1);
        //     },
        //   }),
        //   $("ContextMenuButton", $(go.TextBlock, "Create 1x2 Table"), {
        //     click: function (e, obj) {
        //       e.diagram.toolManager.clickCreatingTool.insertPart(
        //         e.documentPoint,
        //         "TableR3"
        //       );
        //     },
        //   }),
        //   $("ContextMenuButton", $(go.TextBlock, "Create 2x2 Table"), {
        //     click: function (e, obj) {
        //       e.diagram.toolManager.clickCreatingTool.insertPart(
        //         e.documentPoint,
        //         "BlockTable2x2"
        //       );
        //     },
        //   }),
        //   $("ContextMenuButton", $(go.TextBlock, "Bold/Normal"), {
        //     click: function (e, obj) {
        //       toggleTextWeight(obj);
        //     },
        //   }),
        //   $("ContextMenuButton", $(go.TextBlock, "Copy"), {
        //     click: function (e, obj) {
        //       e.diagram.commandHandler.copySelection();
        //     },
        //   }),
        //   $("ContextMenuButton", $(go.TextBlock, "Delete"), {
        //     click: function (e, obj) {
        //       e.diagram.commandHandler.deleteSelection();
        //     },
        //   }),
        //   $("ContextMenuButton", $(go.TextBlock, "Undo"), {
        //     click: function (e, obj) {
        //       e.diagram.commandHandler.undo();
        //     },
        //   }),
        //   $("ContextMenuButton", $(go.TextBlock, "Redo"), {
        //     click: function (e, obj) {
        //       e.diagram.commandHandler.redo();
        //     },
        //   }),
        //   $("ContextMenuButton", $(go.TextBlock, "Layout"), {
        //     click: function (e, obj) {
        //       var adorn = obj.part;
        //       adorn.diagram.startTransaction("Subtree Layout");
        //       layoutTree(adorn.adornedPart);
        //       adorn.diagram.commitTransaction("Subtree Layout");
        //     },
        //   })
        // );
        // the Diagram's context menu just displays commands for general functionality
        myDiagram.contextMenu = $(
          "ContextMenu",
          $(
            "ContextMenuButton",
            $(go.TextBlock, "Paste"),
            {
              click: function (e, obj) {
                e.diagram.commandHandler.pasteSelection(
                  e.diagram.toolManager.contextMenuTool.mouseDownPoint
                );
              },
            },
            new go.Binding("visible", "", function (o) {
              return (
                o.diagram &&
                o.diagram.commandHandler.canPasteSelection(
                  o.diagram.toolManager.contextMenuTool.mouseDownPoint
                )
              );
            }).ofObject()
          ),
          $(
            "ContextMenuButton",
            $(go.TextBlock, "Undo"),
            {
              click: function (e, obj) {
                e.diagram.commandHandler.undo();
              },
            },
            new go.Binding("visible", "", function (o) {
              return o.diagram && o.diagram.commandHandler.canUndo();
            }).ofObject()
          ),
          $("ContextMenuButton", $(go.TextBlock, "Create 1x2 Table"), {
            click: function (e, obj) {
              e.diagram.toolManager.clickCreatingTool.insertPart(
                e.documentPoint,
                "TableR3"
              );
            },
          }),
          $("ContextMenuButton", $(go.TextBlock, "Create 2x2 Table"), {
            click: function (e, obj) {
              e.diagram.toolManager.clickCreatingTool.insertPart(
                e.documentPoint,
                "BlockTable2x2"
              );
            },
          }),
          $(
            "ContextMenuButton",
            $(go.TextBlock, "Redo"),
            {
              click: function (e, obj) {
                e.diagram.commandHandler.redo();
              },
            },
            new go.Binding("visible", "", function (o) {
              return o.diagram && o.diagram.commandHandler.canRedo();
            }).ofObject()
          ),
          $("ContextMenuButton", $(go.TextBlock, "Save"), {
            click: function (e, obj) {
              save();
            },
          }),
          $("ContextMenuButton", $(go.TextBlock, "Load"), {
            click: function (e, obj) {
              load();
            },
          })
        );
        // var cxElement = document.getElementById("contextMenu");
        // var myContextMenu = $(go.HTMLInfo, {
        //   show: showContextMenu,
        //   hide: hideContextMenu,
        // });
        myDiagram.nodeTemplateMap.add(
          "", // default template, for people
          $(
            go.Node,
            "Auto",
            // { contextMenu: myContextMenu },
            { background: "transparent" }, // in front of all Tables
            // when selected is in foreground layer
            new go.Binding("layerName", "isSelected", function (s) {
              return s ? "Foreground" : "";
            }).ofObject(),
            { locationSpot: go.Spot.Center },
            new go.Binding("location", "loc", go.Point.parse).makeTwoWay(
              go.Point.stringify
            ),
            new go.Binding("text", "name"),
            {
              // define a context menu for each node
              contextMenu: $(
                "ContextMenu", // that has one button
                $("ContextMenuButton", $(go.TextBlock, "Gruppe A"), {
                  click: function (e, obj) {
                    // changeColor(e, obj, "A");
                    changeColor2(myGuests, "A");
                    changeColor2(myDiagram, "A");
                  },
                  // click: function (e, obj) {
                  //   e.diagram.commandHandler.deleteSelection();
                  // },
                }),
                $("ContextMenuButton", $(go.TextBlock, "Gruppe B"), {
                  click: function (e, obj) {
                    // changeColor(e, obj, "B");
                    changeColor2(myGuests, "B");
                    changeColor2(myDiagram, "B");
                  },
                  // click: function (e, obj) {
                  //   e.diagram.commandHandler.deleteSelection();
                  // },
                }),
                $("ContextMenuButton", $(go.TextBlock, "Abgemeldet"), {
                  click: function (e, obj) {
                    // console.log("e", e);
                    // console.log("obj", obj);
                    toggleAnwesenheit(myGuests);
                    toggleAnwesenheit(myDiagram);
                    // changeColor(e, obj, "0");
                  },
                  // click: function (e, obj) {
                  //   e.diagram.commandHandler.deleteSelection();
                  // },
                })
                // more ContextMenuButtons would go here
              ), // end Adornment,
              // what to do when a drag-over or a drag-drop occurs on a Node representing a table
              mouseDragEnter: function (e, node, prev) {
                // console.log("dragCopy ", dragCopy);
                var dragCopy =
                  node.diagram.toolManager.draggingTool.copiedParts; // could be copied from palette
                // console.log("dragCopy ", dragCopy);
                highlightSeats(
                  node,
                  dragCopy ? dragCopy : node.diagram.selection,
                  true
                );
              },
              mouseDragLeave: function (e, node, next) {
                var dragCopy =
                  node.diagram.toolManager.draggingTool.copiedParts;
                highlightSeats(
                  node,
                  dragCopy ? dragCopy : node.diagram.selection,
                  false
                );
              },
              mouseDrop: function (e, node) {
                assignPeopleToSeats(
                  node,
                  node.diagram.selection,
                  e.documentPoint
                );
              },
            },
            $(
              go.Shape,
              "Rectangle",
              new go.Binding("fill", "color", function (s) {
                // console.log(s);
                return s ? s : "red";
              })
            ),
            $(
              go.Panel,
              "Viewbox",
              { desiredSize: new go.Size(50, 38) },
              $(
                go.TextBlock,
                {
                  name: "NAMETB",
                  margin: 1,
                  desiredSize: new go.Size(55, NaN),
                  font: "8pt Verdana, sans-serif",
                  textAlign: "center",
                  stroke: "darkblue",
                  editable: true,
                },
                new go.Binding("text", "name").makeTwoWay()
                // new go.Binding("text", "", function (data) {
                //   var s = data.key;

                //   if (data.plus) s += " +" + data.plus.toString();
                //   return s;
                // }).makeTwoWay()
              )
            ),
            $(
              go.TextBlock,
              {
                background: "transparent",
                name: "STATUS_Student",
                margin: 2,
                font: "8pt Verdana, sans-serif",
                alignment: go.Spot.TopRight,
                alignmentFocus: go.Spot.TopRight,
              },
              new go.Binding("text", "gruppe")
            ),
            $(
              go.Panel,
              "Spot",
              { desiredSize: new go.Size(50, 38) },
              new go.Binding("opacity", "ribbon", function (t) {
                return t ? 1 : 0;
              }),
              // note that the opacity defaults to zero (not visible),
              // in case there is no "ribbon" property
              {
                opacity: 0,
                alignment: new go.Spot(1, 0, 5, -5),
                alignmentFocus: go.Spot.TopRight,
              },
              $(
                go.Shape, // the ribbon itself
                {
                  geometryString: "F1 M0 0 L30 0 70 40 70 70z",
                  fill: "red",
                  stroke: null,
                  strokeWidth: 0,
                }
              ),
              $(go.TextBlock, "FEHLT", {
                alignment: new go.Spot(1, 0, -19, 17), //-29, 29),
                angle: 38,
                maxSize: new go.Size(40, NaN),
                stroke: "white",
                font: "bold 8px sans-serif",
                textAlign: "center",
              })
            )
          )
        );

        // Create a seat element at a particular alignment relative to the table.
        function Seat(number, align, focus) {
          if (typeof align === "string") align = go.Spot.parse(align);
          if (!align || !align.isSpot()) align = go.Spot.Right;
          if (typeof focus === "string") focus = go.Spot.parse(focus);
          if (!focus || !focus.isSpot()) focus = align.opposite();
          return $(
            go.Panel,
            "Spot",
            {
              name: number.toString(),
              alignment: align,
              alignmentFocus: focus,
            },
            $(
              go.Shape,
              "Circle",
              {
                name: "SEATSHAPE",
                desiredSize: new go.Size(40, 40),
                fill: "burlywood",
                stroke: "white",
                strokeWidth: 2,
              },
              new go.Binding("fill")
            ),
            $(
              go.TextBlock,
              // number.toString(),
              "frei",
              { font: "10pt Verdana, sans-serif" },
              new go.Binding("angle", "angle", function (n) {
                return -n;
              })
            )
          );
        }

        function tableStyle() {
          return [
            { background: "transparent" },
            // { contextMenu: myContextMenu },
            { layerName: "Background" }, // behind all Persons
            { locationSpot: go.Spot.Center, locationObjectName: "TABLESHAPE" },
            new go.Binding("location", "loc", go.Point.parse).makeTwoWay(
              go.Point.stringify
            ),
            { rotatable: true },
            new go.Binding("angle").makeTwoWay(),
            {
              // what to do when a drag-over or a drag-drop occurs on a Node representing a table
              mouseDragEnter: function (e, node, prev) {
                var dragCopy =
                  node.diagram.toolManager.draggingTool.copiedParts; // could be copied from palette
                // console.log("dragCopy2 ", dragCopy);
                highlightSeats(
                  node,
                  dragCopy ? dragCopy : node.diagram.selection,
                  true
                );
              },
              mouseDragLeave: function (e, node, next) {
                var dragCopy =
                  node.diagram.toolManager.draggingTool.copiedParts;
                highlightSeats(
                  node,
                  dragCopy ? dragCopy : node.diagram.selection,
                  false
                );
              },
              mouseDrop: function (e, node) {
                assignPeopleToSeats(
                  node,
                  node.diagram.selection,
                  e.documentPoint
                );
              },
            },
          ];
        }

        // various kinds of tables:

        myDiagram.nodeTemplateMap.add(
          "TableR8", // rectangular with 8 seats
          $(
            go.Node,
            "Spot",
            tableStyle(),
            $(
              go.Panel,
              "Spot",
              $(
                go.Shape,
                "Rectangle",
                {
                  name: "TABLESHAPE",
                  desiredSize: new go.Size(160, 80),
                  fill: "burlywood",
                  stroke: null,
                },
                new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(
                  go.Size.stringify
                ),
                new go.Binding("fill")
              ),
              $(
                go.TextBlock,
                { editable: true, font: "bold 11pt Verdana, sans-serif" },
                new go.Binding("text", "name").makeTwoWay(),
                new go.Binding("angle", "angle", function (n) {
                  return -n;
                })
              )
            ),
            Seat(1, "0.2 0", "0.5 1"),
            Seat(2, "0.5 0", "0.5 1"),
            Seat(3, "0.8 0", "0.5 1"),
            Seat(4, "1 0.5", "0 0.5"),
            Seat(5, "0.8 1", "0.5 0"),
            Seat(6, "0.5 1", "0.5 0"),
            Seat(7, "0.2 1", "0.5 0"),
            Seat(8, "0 0.5", "1 0.5")
          )
        );

        myDiagram.nodeTemplateMap.add(
          "TableR3", // rectangular with 3 seats in a line
          $(
            go.Node,
            "Spot",
            tableStyle(),
            $(
              go.Panel,
              "Spot",
              $(
                go.Shape,
                "Rectangle",
                {
                  name: "TABLESHAPE",
                  desiredSize: new go.Size(100, 40),
                  fill: "burlywood",
                  stroke: null,
                },
                new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(
                  go.Size.stringify
                ),
                new go.Binding("fill")
              ),
              $(
                go.TextBlock,
                { editable: true, font: "bold 11pt Verdana, sans-serif" },
                new go.Binding("text", "name").makeTwoWay(),
                new go.Binding("angle", "angle", function (n) {
                  return -n;
                })
              )
            ),
            Seat(1, "0.2 1", "0.5 0"),
            Seat(2, "0.8 1", "0.5 0")
          )
        );
        myDiagram.nodeTemplateMap.add(
          "teacher", // rectangular with 3 seats in a line
          $(
            go.Node,
            "Spot",
            tableStyle(),
            $(
              go.Panel,
              "Spot",
              $(
                go.Shape,
                "Rectangle",
                {
                  name: "TABLESHAPE",
                  desiredSize: new go.Size(100, 40),
                  fill: "#afeeee",
                  stroke: null,
                },
                new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(
                  go.Size.stringify
                ),
                new go.Binding("fill")
              ),
              $(
                go.TextBlock,
                { editable: true, font: "bold 11pt Verdana, sans-serif" },
                new go.Binding("text", "name").makeTwoWay(),
                new go.Binding("angle", "angle", function (n) {
                  return -n;
                })
              )
            )
          )
        );
        myDiagram.nodeTemplateMap.add(
          "BlockTable2x2", // rectangular with 3 seats in a line
          $(
            go.Node,
            "Spot",
            tableStyle(),
            $(
              go.Panel,
              "Spot",
              $(
                go.Shape,
                "Rectangle",
                {
                  name: "TABLESHAPE",
                  desiredSize: new go.Size(100, 80),
                  fill: "burlywood",
                  stroke: null,
                },
                new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(
                  go.Size.stringify
                ),
                new go.Binding("fill")
              ),
              $(
                go.TextBlock,
                { editable: true, font: "bold 11pt Verdana, sans-serif" },
                new go.Binding("text", "name").makeTwoWay(),
                new go.Binding("angle", "angle", function (n) {
                  return -n;
                })
              )
            ),
            Seat(1, "0.2 1", "0.5 0"),
            Seat(2, "0.8 1", "0.5 0"),
            Seat(3, "0.2 0", "0.5 1"),
            Seat(4, "0.8 0", "0.5 1")
          )
        );

        myDiagram.nodeTemplateMap.add(
          "TableC8", // circular with 8 seats
          $(
            go.Node,
            "Spot",
            tableStyle(),
            $(
              go.Panel,
              "Spot",
              $(
                go.Shape,
                "Rectangle",
                {
                  name: "TABLESHAPE",
                  desiredSize: new go.Size(120, 120),
                  fill: "#afeeee",
                  stroke: null,
                },
                new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(
                  go.Size.stringify
                ),
                new go.Binding("fill")
              ),
              $(
                go.TextBlock,
                { editable: true, font: "bold 11pt Verdana, sans-serif" },
                new go.Binding("text", "name").makeTwoWay(),
                new go.Binding("angle", "angle", function (n) {
                  return -n;
                })
              )
            )
          )
        );

        // what to do when a drag-drop occurs in the Diagram's background
        myDiagram.mouseDrop = function (e) {
          // when the selection is dropped in the diagram's background,
          // make sure the selected people no longer belong to any table
          console.log(e.diagram);
          e.diagram.selection.each(function (n) {
            if (isPerson(n)) unassignSeat(n.data);
          });
        };

        // to simulate a "move" from the Palette, the source Node must be deleted.
        myDiagram.addDiagramListener("ExternalObjectsDropped", function (e) {
          // if any Tables were dropped, don't delete from myGuests
          if (!e.subject.any(isTable)) {
            myGuests.commandHandler.deleteSelection();
          }
        });

        // put deleted people back in the myGuests diagram
        myDiagram.addDiagramListener("SelectionDeleted", function (e) {
          // no-op if deleted by myGuests' ExternalObjectsDropped listener
          if (myDiagram.disableSelectionDeleted) return;
          // e.subject is the myDiagram.selection collection
          e.subject.each(function (n) {
            if (isPerson(n)) {
              myGuests.model.addNodeData(myGuests.model.copyNodeData(n.data));
            }
          });
        });

        // create some initial tables
        myDiagram.model = new go.GraphLinksModel([
          {
            key: 1,
            category: "TableR3",
            name: "",
            guests: {},
          },
          {
            key: 2,
            category: "TableR3",
            name: "",
            guests: {},
          },
          {
            key: 3,
            category: "TableR3",
            name: "",
            guests: {},
          },
          {
            key: 4,
            category: "teacher",
            name: "Lehrertisch",
            guests: {},
          },
          {
            key: 5,
            category: "TableR3",
            name: "",
            guests: {},
          },
          {
            key: 6,
            category: "TableR3",
            name: "",
            guests: {},
          },
          {
            key: 7,
            category: "TableR3",
            name: "",
            guests: {},
          },
          {
            key: 8,
            category: "TableR3",
            name: "",
            guests: {},
          },
        ]); // this sample does not make use of any links

        // initialize the Palette
        myGuests = $(
          go.Diagram,
          "myGuests",

          {
            "clickCreatingTool.archetypeNodeData": {
              // allow double-click in background to create a new node
              color: "tomato",
              gruppe: "0",
            },
            "clickCreatingTool.insertPart": function (loc) {
              // scroll to the new node
              var node = go.ClickCreatingTool.prototype.insertPart.call(
                this,
                loc
              );
              if (node !== null) {
                this.diagram.select(node);
                this.diagram.commandHandler.scrollToPart(node);
                this.diagram.commandHandler.editTextBlock(
                  node.findObject("NAMETB")
                );
              }
              return node;
            },
            // For this sample, automatically show the state of the diagram's model on the page
            ModelChanged: function (e) {
              if (e.isTransactionFinished) {
                document.getElementById("mySavedModel").value =
                  '{\n "plan": ' +
                  myDiagram.model.toJson() +
                  ",\n" +
                  '"students":' +
                  myGuests.model.toJson() +
                  "}";
                myGuests.layoutDiagram(true);
                prettyPrint();
              }
            },
            layout: $(go.GridLayout, {
              sorting: go.GridLayout.Ascending, // sort by Node.text value
              comparer: function (pa, pb) {
                var da = pa.data;
                var db = pb.data;
                if (da.gruppe < db.gruppe) return -1;
                if (da.gruppe > db.gruppe) return 1;
                return 0;
              },
            }),
            allowDragOut: true, // to myDiagram
            allowMove: false,
          }
        );
        myGuests.contextMenu = $(
          "ContextMenu",

          $("ContextMenuButton", $(go.TextBlock, "Create Student"), {
            click: function (e, obj) {
              e.diagram.toolManager.clickCreatingTool.insertPart(
                e.documentPoint
              );
            },
          })
        );
        myGuests.nodeTemplateMap = myDiagram.nodeTemplateMap;

        // specify the contents of the Palette

        let studentlist = [
          { name: "Amin", gruppe: "A" },
          { name: "Mehrab", gruppe: "A" }, // dragons, of course
          { name: "Andrej", gruppe: "A" },
          { name: "Ebrar", gruppe: "A" },
          { name: "Ivan", gruppe: "A" },
          { name: "KÃ¼bra", gruppe: "A" },
          { name: "Marha", gruppe: "A" },
          { name: "Magomed", gruppe: "A" },
          { name: "Melike", gruppe: "A" },
          { name: "Mihai", gruppe: "A" },
          { name: "Szanella", gruppe: "A" },
          { name: "Dejana", gruppe: "A" }, // dragons, of course
          { name: "Belmin", gruppe: "B" },
          { name: "Mirjana", gruppe: "B" },
          { name: "Iliyan", gruppe: "B" },
          { name: "Amine", gruppe: "B" },
          { name: "Ivona", gruppe: "B" },
          { name: "Hamza", gruppe: "B" },
          { name: "Ionuts", gruppe: "B" },
          { name: "Berin", gruppe: "B" },
          { name: "Mateja", gruppe: "B" },
          { name: "Abu", gruppe: "B", ribbon: true },
          { name: "Hamsat", gruppe: "B" },
          { name: "Rufa", gruppe: "B" },
        ];

        studentlist.forEach((item) => {
          switch (item.gruppe) {
            case "A":
              item.color = "lightyellow";
              break;
            case "B":
              item.color = "lightblue";
              break;
            default:
              item.color = "white";
              break;
          }
        });

        myGuests.model = new go.GraphLinksModel(studentlist);

        myGuests.model.undoManager = myDiagram.model.undoManager; // shared UndoManager!

        function changeColor2(diagram, gruppe) {
          // Always make changes in a transaction, except when initializing the diagram.
          diagram.startTransaction("change color");
          diagram.selection.each(function (node) {
            if (node instanceof go.Node) {
              // ignore any selected Links and simple Parts
              // Examine and modify the data, not the Node directly.
              var data = node.data;
              let newcolor;
              switch (gruppe) {
                case "A":
                  newcolor = "lightyellow";
                  break;
                case "B":
                  newcolor = "lightblue";
                  break;
                default:
                  newcolor = "white";
                  break;
              }
              // Call setDataProperty to support undo/redo as well as
              // automatically evaluating any relevant bindings.
              diagram.model.setDataProperty(data, "color", newcolor);
              diagram.model.setDataProperty(data, "gruppe", gruppe);
            }
          });
          diagram.commitTransaction("change color");
          diagram.clearSelection();
        }
        function toggleAnwesenheit(diagram) {
          // Always make changes in a transaction, except when initializing the diagram.
          diagram.startTransaction("change status");
          diagram.selection.each(function (node) {
            if (node instanceof go.Node) {
              // ignore any selected Links and simple Parts
              // Examine and modify the data, not the Node directly.
              var data = node.data;
              var model = diagram.model;

              // Call setDataProperty to support undo/redo as well as
              // automatically evaluating any relevant bindings.
              diagram.model.setDataProperty(data, "ribbon", !data.ribbon);
            }
          });
          diagram.commitTransaction("change status");
          diagram.clearSelection();
        }

        // // A custom command, for changing the color of the selected node(s).

        // To simulate a "move" from the Diagram back to the Palette, the source Node must be deleted.
        myGuests.addDiagramListener("ExternalObjectsDropped", function (e) {
          // e.subject is the myGuests.selection collection
          // if the user dragged a Table to the myGuests diagram, cancel the drag
          if (e.subject.any(isTable)) {
            myDiagram.currentTool.doCancel();
            myGuests.currentTool.doCancel();
            return;
          }
          myDiagram.selection.each(function (n) {
            if (isPerson(n)) unassignSeat(n.data);
          });
          myDiagram.disableSelectionDeleted = true;
          myDiagram.commandHandler.deleteSelection();
          myDiagram.disableSelectionDeleted = false;
          myGuests.selection.each(function (n) {
            if (isPerson(n)) unassignSeat(n.data);
          });
        });
        const queryString = window.location.search;
        console.log(queryString);

        const urlParams = new URLSearchParams(queryString);
        if (urlParams.has("config")) {
          let saved_plan = uriToJson(urlParams.get("config"));
          console.log(saved_plan);
          myDiagram.model = go.Model.fromJson(JSON.stringify(saved_plan.plan));
          myGuests.model = go.Model.fromJson(
            JSON.stringify(saved_plan.students)
          );
        }
        history.pushState(
          {},
          null,
          window.location.href.replace(window.location.search, "")
        );
      } // end init

      function isPerson(n) {
        return n !== null && n.category === "";
      }

      function isTable(n) {
        return n !== null && n.category !== "";
      }

      // Highlight the empty and occupied seats at a "Table" Node
      function highlightSeats(node, coll, show) {
        if (isPerson(node)) {
          // refer to the person's table instead
          node = node.diagram.findNodeForKey(node.data.table);
          if (node === null) return;
        }
        var it = coll.iterator;
        while (it.next()) {
          var n = it.key;
          // if dragging a Table, don't do any highlighting
          if (isTable(n)) return;
        }
        var guests = node.data.guests;
        for (var sit = node.elements; sit.next(); ) {
          var seat = sit.value;
          if (seat.name) {
            var num = parseFloat(seat.name);
            if (isNaN(num)) continue;
            var seatshape = seat.findObject("SEATSHAPE");
            if (!seatshape) continue;
            if (show) {
              if (guests[seat.name]) {
                seatshape.stroke = "red";
              } else {
                seatshape.stroke = "green";
              }
            } else {
              seatshape.stroke = "white";
            }
          }
        }
      }

      function nodeDoubleClick(e, obj) {
        var clicked = obj.part;
        if (clicked !== null) {
          var thisemp = clicked.data;
          myDiagram.startTransaction("add employee");
          var newemp = {
            name: "(new person)",
            title: "",
            comments: "",
            parent: thisemp.key,
          };
          myDiagram.model.addNodeData(newemp);
          myDiagram.commitTransaction("add employee");
        }
      }

      // Given a "Table" Node, assign seats for all of the people in the given collection of Nodes;
      // the optional Point argument indicates where the collection of people may have been dropped.
      function assignPeopleToSeats(node, coll, pt) {
        if (isPerson(node)) {
          // refer to the person's table instead
          node = node.diagram.findNodeForKey(node.data.table);
          if (node === null) return;
        }
        if (coll.any(isTable)) {
          // if dragging a Table, don't allow it to be dropped onto another table
          myDiagram.currentTool.doCancel();
          return;
        }
        // OK -- all Nodes are people, call assignSeat on each person data
        coll.each(function (n) {
          assignSeat(node, n.data, pt);
        });
        positionPeopleAtSeats(node);
        myDiagram.clearSelection();
      }

      // Given a "Table" Node, assign one guest data to a seat at that table.
      // Also handles cases where the guest represents multiple people, because guest.plus > 0.
      // This tries to assign the unoccupied seat that is closest to the given point in document coordinates.
      function assignSeat(node, guest, pt) {
        console.log("guest", guest);
        console.log("node", node);
        if (isPerson(node)) {
          // refer to the person's table instead
          node = node.diagram.findNodeForKey(node.data.table);
          if (node === null) return;
        }
        if (guest instanceof go.GraphObject)
          throw Error(
            "A guest object must not be a GraphObject: " + guest.toString()
          );
        if (!(pt instanceof go.Point)) pt = node.location;

        // in case the guest used to be assigned to a different seat, perhaps at a different table
        unassignSeat(guest);

        var model = node.diagram.model;
        var guests = node.data.guests;
        // iterate over all seats in the Node to find one that is not occupied
        var closestseatname = findClosestUnoccupiedSeat(node, pt);
        if (closestseatname) {
          model.setDataProperty(guests, closestseatname, guest.key);
          model.setDataProperty(guest, "table", node.data.key);
          model.setDataProperty(guest, "seat", parseFloat(closestseatname));
        }

        var plus = guest.plus;
        if (plus) {
          // represents several people
          // forget the "plus" info, since next we create N copies of the node/data
          guest.plus = undefined;
          model.updateTargetBindings(guest);
          for (var i = 0; i < plus; i++) {
            var copy = model.copyNodeData(guest);
            // don't copy the seat assignment of the first person
            copy.table = undefined;
            copy.seat = undefined;
            model.addNodeData(copy);
            assignSeat(node, copy, pt);
          }
        }
      }

      // Declare that the guest represented by the data is no longer assigned to a seat at a table.
      // If the guest had been at a table, the guest is removed from the table's list of guests.
      function unassignSeat(guest) {
        if (guest instanceof go.GraphObject)
          throw Error(
            "A guest object must not be a GraphObject: " + guest.toString()
          );
        var model = myDiagram.model;
        // remove from any table that the guest is assigned to
        if (guest.table) {
          var table = model.findNodeDataForKey(guest.table);
          if (table) {
            var guests = table.guests;
            if (guests)
              model.setDataProperty(guests, guest.seat.toString(), undefined);
          }
        }
        model.setDataProperty(guest, "table", undefined);
        model.setDataProperty(guest, "seat", undefined);
      }

      // Find the name of the unoccupied seat that is closest to the given Point.
      // This returns null if no seat is available at this table.
      function findClosestUnoccupiedSeat(node, pt) {
        if (isPerson(node)) {
          // refer to the person's table instead
          node = node.diagram.findNodeForKey(node.data.table);
          if (node === null) return;
        }
        var guests = node.data.guests;
        var closestseatname = null;
        var closestseatdist = Infinity;
        // iterate over all seats in the Node to find one that is not occupied
        for (var sit = node.elements; sit.next(); ) {
          var seat = sit.value;
          if (seat.name) {
            var num = parseFloat(seat.name);
            if (isNaN(num)) continue; // not really a "seat"
            if (guests[seat.name]) continue; // already assigned
            var seatloc = seat.getDocumentPoint(go.Spot.Center);
            var seatdist = seatloc.distanceSquaredPoint(pt);
            if (seatdist < closestseatdist) {
              closestseatdist = seatdist;
              closestseatname = seat.name;
            }
          }
        }
        return closestseatname;
      }

      // Position the nodes of all of the guests that are seated at this table
      // to be at their corresponding seat elements of the given "Table" Node.
      function positionPeopleAtSeats(node) {
        if (isPerson(node)) {
          // refer to the person's table instead
          node = node.diagram.findNodeForKey(node.data.table);
          if (node === null) return;
        }
        var guests = node.data.guests;
        var model = node.diagram.model;
        for (var seatname in guests) {
          var guestkey = guests[seatname];
          var guestdata = model.findNodeDataForKey(guestkey);
          positionPersonAtSeat(guestdata);
        }
      }

      // Position a single guest Node to be at the location of the seat to which they are assigned.
      function positionPersonAtSeat(guest) {
        if (guest instanceof go.GraphObject)
          throw Error(
            "A guest object must not be a GraphObject: " + guest.toString()
          );
        if (!guest || !guest.table || !guest.seat) return;
        var diagram = myDiagram;
        var table = diagram.findPartForKey(guest.table);
        var person = diagram.findPartForData(guest);
        if (table && person) {
          var seat = table.findObject(guest.seat.toString());
          var loc = seat.getDocumentPoint(go.Spot.Center);
          person.location = loc;
        }
      }

      // Automatically drag people Nodes along with the table Node at which they are seated.
      function SpecialDraggingTool() {
        go.DraggingTool.call(this);
        this.isCopyEnabled = false; // don't want to copy people except between Diagrams
      }
      go.Diagram.inherit(SpecialDraggingTool, go.DraggingTool);

      SpecialDraggingTool.prototype.computeEffectiveCollection = function (
        parts
      ) {
        var map = go.DraggingTool.prototype.computeEffectiveCollection.call(
          this,
          parts
        );
        // console.log("map;: ", map);
        // for each Node representing a table, also drag all of the people seated at that table
        parts.each(function (table) {
          if (isPerson(table)) return; // ignore persons
          // this is a table Node, find all people Nodes using the same table key
          for (var nit = table.diagram.nodes; nit.next(); ) {
            var n = nit.value;
            if (isPerson(n) && n.data.table === table.data.key) {
              if (!map.has(n))
                map.add(n, new go.DraggingInfo(n.location.copy()));
            }
          }
        });
        return map;
      };
      // end SpecialDraggingTool

      // Automatically move seated people as a table is rotated, to keep them in their seats.
      // Note that because people are separate Nodes, rotating a table Node means the people Nodes
      // are not rotated, so their names (TextBlocks) remain horizontal.
      function HorizontalTextRotatingTool() {
        go.RotatingTool.call(this);
      }
      go.Diagram.inherit(HorizontalTextRotatingTool, go.RotatingTool);

      HorizontalTextRotatingTool.prototype.rotate = function (newangle) {
        go.RotatingTool.prototype.rotate.call(this, newangle);
        var node = this.adornedObject.part;
        positionPeopleAtSeats(node);
      };
      function save() {
        document.getElementById("mySavedModel").value =
          '{\n "plan": ' +
          myDiagram.model.toJson() +
          ",\n" +
          '"students":' +
          myGuests.model.toJson() +
          "}";
        document.getElementById("SaveButton").disabled = true;
        document.getElementById("SaveButton").innerHTML = `<span
                    class="spinner-border spinner-border-sm"
                    role="status"
                    style="vertical-align: middle;"
                    aria-hidden="true"
                  ></span>
                  Creating Sitzplan`;

        tinyurl(
          "https://simonstey.github.io/sitzplan?config=" +
            jsonToUri(
              JSON.parse(document.getElementById("mySavedModel").value)
            ),
          () => {
            window.copyToClipboard(tinyurl.url);
            console.log(tinyurl.url);
            QRCode.toCanvas(
              document.getElementById("QRcanvas"),
              tinyurl.url,
              function (error) {
                if (error) console.error(error);
                console.log("success!");
              }
            );
            document.getElementById("SaveButton").innerHTML = "Save";
            document.getElementById("SaveButton").disabled = false;
            console.log(tinyurl.preview);
          }
        );
        myDiagram.isModified = false;
      }
      function load() {
        if (typeof document.getElementById("mySavedModel").value == "string") {
          console.log(document.getElementById("mySavedModel").value);
          var saved_plan = JSON.parse(
            document.getElementById("mySavedModel").value
          );
        } else {
          var saved_plan = document.getElementById("mySavedModel").value;
        }

        myDiagram.model = go.Model.fromJson(JSON.stringify(saved_plan.plan));
        myGuests.model = go.Model.fromJson(JSON.stringify(saved_plan.students));
      }
      // end HorizontalTextRotatingTool
      // This common function is called both when showing the PDF in an iframe and when downloading a PDF file.
      // The options include:
      //   "pageSize", either "A4" or "LETTER" (the default)
      //   "layout", either "portrait" (the default) or "landscape"
      //   "margin" for the uniform page margin on each page (default is 36 pt)
      //   "padding" instead of the Diagram.padding when adjusting the Diagram.documentBounds for the area to render
      //   "imgWidth", size of diagram image for one page; defaults to the page width minus margins
      //   "imgHeight", size of diagram image for one page; defaults to the page height minus margins
      //   "imgResolutionFactor" for how large the image should be scaled when rendered for each page;
      //     larger is better but significantly increases memory usage (default is 3)
      //   "parts", "background", "showTemporary", "showGrid", all are passed to Diagram.makeImageData
      function generatePdf(action, diagram, options) {
        if (!(diagram instanceof go.Diagram))
          throw new Error("no Diagram provided when calling generatePdf");
        if (!options) options = {};

        var pageSize = options.pageSize || "LETTER";
        pageSize = pageSize.toUpperCase();
        if (pageSize !== "LETTER" && pageSize !== "A4")
          throw new Error("unknown page size: " + pageSize);
        // LETTER: 612x792 pt == 816x1056 CSS units
        // A4: 595.28x841.89 pt == 793.71x1122.52 CSS units
        var pageWidth = ((pageSize === "LETTER" ? 612 : 595.28) * 96) / 72; // convert from pt to CSS units
        var pageHeight = ((pageSize === "LETTER" ? 792 : 841.89) * 96) / 72;

        var layout = options.layout || "portrait";
        layout = layout.toLowerCase();
        if (layout !== "portrait" && layout !== "landscape")
          throw new Error("unknown layout: " + layout);
        if (layout === "landscape") {
          var temp = pageWidth;
          pageWidth = pageHeight;
          pageHeight = temp;
        }

        var margin = options.margin !== undefined ? options.margin : 36; // pt: 0.5 inch margin on each side
        var padding =
          options.padding !== undefined ? options.padding : diagram.padding; // CSS units

        var imgWidth =
          options.imgWidth !== undefined
            ? options.imgWidth
            : pageWidth - (margin / 72) * 96 * 2; // CSS units
        var imgHeight =
          options.imgHeight !== undefined
            ? options.imgHeight
            : pageHeight - (margin / 72) * 96 * 2; // CSS units
        var imgResolutionFactor =
          options.imgResolutionFactor !== undefined
            ? options.imgResolutionFactor
            : 3;

        var pageOptions = {
          size: pageSize,
          margin: margin, // pt
          layout: layout,
        };

        require(["blob-stream", "pdfkit"], function (blobStream, PDFDocument) {
          var doc = new PDFDocument(pageOptions);
          var stream = doc.pipe(blobStream());
          var bnds = diagram.documentBounds;

          // add some descriptive text
          //doc.text(diagram.nodes.count + " nodes, " + diagram.links.count + " links  Diagram size: " + bnds.width.toFixed(2) + " x " + bnds.height.toFixed(2));

          var db = diagram.documentBounds
            .copy()
            .subtractMargin(diagram.padding)
            .addMargin(padding);
          var p = db.position;
          // iterate over page areas of document bounds
          for (var j = 0; j < db.height; j += imgHeight) {
            for (var i = 0; i < db.width; i += imgWidth) {
              // if any page has no Parts partially or fully in it, skip rendering that page
              var r = new go.Rect(p.x + i, p.y + j, imgWidth, imgHeight);
              if (diagram.findPartsIn(r, true, false).count === 0) continue;

              if (i > 0 || j > 0) doc.addPage(pageOptions);

              var makeOptions = {};
              if (options.parts !== undefined)
                makeOptions.parts = options.parts;
              if (options.background !== undefined)
                makeOptions.background = options.background;
              if (options.showTemporary !== undefined)
                makeOptions.showTemporary = options.showTemporary;
              if (options.showGrid !== undefined)
                makeOptions.showGrid = options.showGrid;
              makeOptions.scale = imgResolutionFactor;
              makeOptions.position = new go.Point(p.x + i, p.y + j);
              makeOptions.size = new go.Size(
                imgWidth * imgResolutionFactor,
                imgHeight * imgResolutionFactor
              );
              makeOptions.maxSize = new go.Size(Infinity, Infinity);

              var imgdata = diagram.makeImageData(makeOptions);
              doc.image(imgdata, {
                scale: 1 / ((imgResolutionFactor * 96) / 72),
              });
            }
          }

          doc.end();
          stream.on("finish", function () {
            action(stream.toBlob("application/pdf"));
          });
        });
      }

      // Two different uses of generatePdf: one shows the PDF document in the page,
      // the other downloads it as a file and the user specifies where to save it.

      var pdfOptions =
        // shared by both ways of generating PDF
        {
          showTemporary: true, // default is false
          layout: "landscape", // instead of "portrait"
          pageSize: "A4", // instead of "LETTER"
        };

      function showPdf() {
        generatePdf(
          function (blob) {
            var datauri = window.URL.createObjectURL(blob);
            var frame = document.getElementById("myFrame");
            if (frame) {
              frame.style.display = "block";
              frame.src = datauri; // doesn't work in IE 11, but works everywhere else
              setTimeout(function () {
                window.URL.revokeObjectURL(datauri);
              }, 1);
            }
          },
          myDiagram,
          pdfOptions
        );
      }

      function downloadPdf() {
        generatePdf(
          function (blob) {
            var datauri = window.URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.style = "display: none";
            a.href = datauri;
            a.download = "myDiagram.pdf";

            if (window.navigator.msSaveBlob !== undefined) {
              // IE 11 & Edge
              window.navigator.msSaveBlob(blob, a.download);
              window.URL.revokeObjectURL(datauri);
              return;
            }

            document.body.appendChild(a);
            requestAnimationFrame(function () {
              a.click();
              window.URL.revokeObjectURL(datauri);
              document.body.removeChild(a);
            });
          },
          myDiagram,
          pdfOptions
        );
      }
      (function () {
        // base64 character set, plus padding character (=)
        var b64 =
            "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
          // Regular expression to check formal correctness of base64 encoded strings
          b64re = /^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/;

        window.btoa =
          window.btoa ||
          function (string) {
            string = String(string);
            var bitmap,
              a,
              b,
              c,
              result = "",
              i = 0,
              rest = string.length % 3; // To determine the final padding

            for (; i < string.length; ) {
              if (
                (a = string.charCodeAt(i++)) > 255 ||
                (b = string.charCodeAt(i++)) > 255 ||
                (c = string.charCodeAt(i++)) > 255
              )
                throw new TypeError(
                  "Failed to execute 'btoa' on 'Window': The string to be encoded contains characters outside of the Latin1 range."
                );

              bitmap = (a << 16) | (b << 8) | c;
              result +=
                b64.charAt((bitmap >> 18) & 63) +
                b64.charAt((bitmap >> 12) & 63) +
                b64.charAt((bitmap >> 6) & 63) +
                b64.charAt(bitmap & 63);
            }

            // If there's need of padding, replace the last 'A's with equal signs
            return rest
              ? result.slice(0, rest - 3) + "===".substring(rest)
              : result;
          };

        window.atob =
          window.atob ||
          function (string) {
            // atob can work with strings with whitespaces, even inside the encoded part,
            // but only \t, \n, \f, \r and ' ', which can be stripped.
            string = String(string).replace(/[\t\n\f\r ]+/g, "");
            if (!b64re.test(string))
              throw new TypeError(
                "Failed to execute 'atob' on 'Window': The string to be decoded is not correctly encoded."
              );

            // Adding the padding if missing, for semplicity
            string += "==".slice(2 - (string.length & 3));
            var bitmap,
              result = "",
              r1,
              r2,
              i = 0;
            for (; i < string.length; ) {
              bitmap =
                (b64.indexOf(string.charAt(i++)) << 18) |
                (b64.indexOf(string.charAt(i++)) << 12) |
                ((r1 = b64.indexOf(string.charAt(i++))) << 6) |
                (r2 = b64.indexOf(string.charAt(i++)));

              result +=
                r1 === 64
                  ? String.fromCharCode((bitmap >> 16) & 255)
                  : r2 === 64
                  ? String.fromCharCode(
                      (bitmap >> 16) & 255,
                      (bitmap >> 8) & 255
                    )
                  : String.fromCharCode(
                      (bitmap >> 16) & 255,
                      (bitmap >> 8) & 255,
                      bitmap & 255
                    );
            }
            return result;
          };
      })();
    </script>
    <script>
      function prettyPrint() {
        var ugly = document.getElementById("mySavedModel").value;
        var obj = JSON.parse(ugly);
        var pretty = JSON.stringify(obj, undefined, 4);
        document.getElementById("mySavedModel").value = pretty;
      }
    </script>
  </head>
  <body onload="init()">
    <div id="sample">
      <div id="myFlexDiv">
        <div id="myGuests" style="border: solid 1px black;"></div>

        <!-- <div style="position: relative;"> -->
        <div id="myDiagramDiv" style="border: solid 1px black;"></div>
      </div>

      <!-- <div class="container"> -->
      <div class="row d-flex" style="padding-top: 2vh;">
        <div class="col flex-grow-1">
          <button
            id="SaveButton"
            class="btn btn-primary btn-sm"
            onclick="save()"
          >
            Save
          </button>

          <button class="btn btn-primary btn-sm" onclick="load()">
            Load
          </button>
          <!-- <div><button onclick="showPdf()">Show PDF</button> <button onclick="downloadPdf()">Download PDF</button></div> -->
          <button class="btn btn-primary btn-sm" onclick="downloadPdf()">
            Generate PDF
          </button>
          <br />
          Diagram Model saved in JSON format:

          <textarea id="mySavedModel" style="width: 100%; height: 400px;">
          </textarea>
        </div>
        <div class="flex-shrink-1"><canvas id="QRcanvas"></canvas></div>
      </div>
    </div>
    <!-- </div> -->
  </body>
</html>
